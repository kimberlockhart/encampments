<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	<meta charset="utf-8">
	<title>Encampment Data</title>
	<style>
	body {
		background-color: #EEE !important;
	}
	#map {
		height: 100%;
	}
	#sidebar {
		background-color: #FFF;
		height: 100%;
	}
	html, body {
		height: 100%;
		margin: 0;
		padding: 0;
	}
	
	.row, .container{
		height: 100%;
	}
	
	.input-daterange {
		padding: 0 15px;
	}
	</style>
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/css/bootstrap-datepicker.min.css">
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/js/bootstrap-datepicker.min.js"></script>
		
</head>
<body>
	<div class="container">
		<div class="row">
			<div id="map" class="col-md-9" role="main"></div>
			<div id="sidebar" class="col-md-3" role="complementary">
				<h2>Encampment Map</h2>
				<form id="controls">
					
					<div class="form-group">
				    	<label>Date Range</label>
						<div class="input-group row">
							<div class="input-daterange input-group pas" id="datepicker">
							    <input id="start" type="text" class="input-sm form-control" name="start" />
							    <span class="input-group-addon">to</span>
							    <input id="end" type="text" class="input-sm form-control" name="end" />
							</div>
						</div>
				  	</div>
					<label>Criteria</label>
					<div class="checkbox">
			    		<label>
			      			<input id="open" type="checkbox"> Open Cases
			    		</label>
			  		</div>
				</form>
			</div>
		</div>
	</div>
	<script>
	
	//@TODO: Adjust info displayed on click on marker per Amy's preferences
	//@TODO: Add a different type of marker for known encampments

	function init() {
		var today = new Date();
		var beginningOfTime = new Date(today.getFullYear() - 1, 1, 1, 0, 0, 0, 0);
		
		var defaultStartDate = new Date(2017, 0, 1, 0, 0, 0, 0);
		var defaultEndDate = today;
		
		$('#start').val(toHumanString(defaultStartDate));
		$('#end').val(toHumanString(defaultEndDate));
		
		// Date Picker init must occur after default dates are set
		$(".input-daterange").datepicker({
			autoclose: true,
			assumeNearbyYear: true,
			startDate: toHumanString(beginningOfTime)
		});
		
		$("#controls").change(controlsChanged);		
		buildMap(toApiString(defaultStartDate), toApiString(defaultEndDate), false);
	}
	
	// Returns MM/DD/YYYY
	function toHumanString(date) {
		return doubleDigit(date.getMonth() + 1) + "/" + doubleDigit(date.getDate()) + "/" + date.getFullYear();
	}
	
	// Returns YYYY-MM-DDT00:00:00
	function toApiString(date) {
		return date.getFullYear() + "-" + doubleDigit(date.getMonth() + 1) + "-" + doubleDigit(date.getDate()) + "T00:00:00";
	}
	
	function doubleDigit(number) {
		if (number > 9) return number;
		return "0" + number;
	}
	
	function controlsChanged() {
		var open = $('#open').is(":checked");
		var start = new Date($('#start').val());
		var end = new Date ($('#end').val());
		buildMap(toApiString(start), toApiString(end), open);
	}

	function buildMap(start, end, open) {
		var range = "opened >= '" + start + "' AND opened <= '" + end + "'";
		var params = {request_type: "Illegal Encampment", $where: range, $limit: 10000};
		if (open) {
			params["status"] = "Open"
		}

		// Fetch Incident Data from 311
		$.get("https://data.sfgov.org/resource/ktji-gk7t.json?" + $.param(params), function(data) {
			drawMap(data);	
		});
	}
	
	function getInfoWindow(datum) {
		var content = "<h3>" + datum.request_type + " <span class='badge'>" + datum.status + "</span></h3>" 
		+ "<b>Type:</b> " + datum.request_details + "<br />" 
		+ "<b>Category:</b> " + datum.category + "<br />" 
		+ "<b>Address:</b> " + datum.address + "<br />" 
		+ "<b>Date Opened:</b> " + datum.opened.substr(0, 10);
		if (datum.closed) content += "<br /><b>Date Closed:</b> " + datum.closed.substr(0, 10);
		if (datum.status_notes) content += "<br /><b>Status Notes:</b> " + datum.status_notes;
		return new google.maps.InfoWindow({content: content});
	}

	function drawMap(data) {
		// Center on San Francisco
		var map = new google.maps.Map(document.getElementById('map'), {
			zoom: 13,
			center: {lat: 37.78, lng: -122.45}
		});

		var markers = data.map(function(datum, i) {
			// Some API data is corrupt, skip those data points
			if (typeof(datum) === "undefined" || typeof(datum.point) === "undefined") return;
			if (datum.request_details != "Encampment Cleanup" && datum.request_details != "Carts" && datum.request_details != "Storage") alert(datum.request_details);
			var marker = new google.maps.Marker({
				position: {lat: datum.point.coordinates[1], lng: datum.point.coordinates[0]},
				title: datum.request_details,
			});
			var infoWindow = getInfoWindow(datum);
			marker.infoWindow = infoWindow;
			// Add infoWindow handler to each marker so it operates when it's no longer part of a cluster
			marker.addListener("click", function() {infoWindow.open(map, marker);});
			return marker;
		});

		markerCluster = new MarkerClusterer(map, markers,
			{zoomOnClick: false, imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
		// On click, show each infoWindow in sequence
		google.maps.event.addListener(markerCluster, "clusterclick", function(cluster) {
			if (typeof(cluster.counter) == 'undefined') cluster.counter = 0;
			if (cluster.infoWindow) cluster.infoWindow.close();
			var size = cluster.getSize();
			var markerIndex = cluster.counter % size;
			var markers = cluster.getMarkers();
			var infoWindow = markers[markerIndex].infoWindow;
			infoWindow.setPosition(cluster.getCenter());
			infoWindow.open(map);
			cluster.infoWindow = infoWindow;
			cluster.counter++;
		});	

	}
	
	</script>
	<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
	</script>
	<script async defer
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvPmMRylI-M4h7Zurwjrh8jwd7_qSGrw4&callback=init">
	</script>
</body>
</html>